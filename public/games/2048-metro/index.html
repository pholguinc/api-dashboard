<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>2048 Metro - Conecta las Estaciones del Metro de Lima</title>
  <link href="style/main.css" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="meta/apple-touch-icon.png">
  <link rel="apple-touch-startup-image" href="meta/apple-touch-startup-image-640x1096.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="meta/apple-touch-startup-image-640x920.png"  media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
  <style>
    body { 
      margin: 0; 
      padding: 20px;
      font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: #776e65;
      font-size: 18px;
    }
    .container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .heading { 
      text-align: center; 
      color: #776e65;
      font-size: 48px;
      font-weight: bold;
      margin: 0 0 10px 0;
    }
    .subtitle {
      text-align: center;
      color: #ff6b35;
      font-size: 16px;
      margin: 0 0 20px 0;
      font-weight: bold;
    }
    .score-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .score-box {
      background: #bbada0;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      min-width: 60px;
    }
    .score-box .score-addition {
      color: #f9f6f2;
      font-size: 14px;
    }
    .game-container {
      position: relative;
      background: #bbada0;
      border-radius: 10px;
      width: 500px;
      height: 500px;
      margin: 0 auto;
    }
    .grid-container {
      position: absolute;
      z-index: 1;
    }
    .grid-row {
      margin-bottom: 15px;
    }
    .grid-row:last-child {
      margin-bottom: 0;
    }
    .grid-cell {
      width: 106.25px;
      height: 106.25px;
      background: rgba(238, 228, 218, 0.35);
      border-radius: 6px;
      margin-right: 15px;
      float: left;
    }
    .grid-cell:last-child {
      margin-right: 0;
    }
    .tile-container {
      position: absolute;
      z-index: 2;
    }
    .tile {
      position: absolute;
      width: 106.25px;
      height: 106.25px;
      background: #eee4da;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
      line-height: 106.25px;
      font-size: 32px;
      transition: all 0.15s ease-in-out;
    }
    .tile-2 { background: #eee4da; color: #776e65; }
    .tile-4 { background: #ede0c8; color: #776e65; }
    .tile-8 { background: #f2b179; color: #f9f6f2; }
    .tile-16 { background: #f59563; color: #f9f6f2; }
    .tile-32 { background: #f67c5f; color: #f9f6f2; }
    .tile-64 { background: #f65e3b; color: #f9f6f2; }
    .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 28px; }
    .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 28px; }
    .tile-512 { background: #edc850; color: #f9f6f2; font-size: 28px; }
    .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 24px; }
    .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 24px; }
    .game-message {
      display: none;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 100;
      text-align: center;
      border-radius: 10px;
    }
    .game-message p {
      font-size: 60px;
      font-weight: bold;
      height: 60px;
      line-height: 60px;
      margin-top: 222px;
    }
    .game-message .lower {
      display: block;
      margin-top: 59px;
    }
    .game-message a {
      display: inline-block;
      background: #8f7a66;
      border-radius: 3px;
      padding: 0 20px;
      text-decoration: none;
      color: #f9f6f2;
      height: 40px;
      line-height: 42px;
      margin-left: 9px;
    }
    .restart-button {
      background: #8f7a66;
      border-radius: 3px;
      padding: 0 20px;
      color: #f9f6f2;
      height: 40px;
      line-height: 42px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin: 20px auto;
      display: block;
    }
    .instructions {
      background: #f9f6f2;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      border-left: 4px solid #ff6b35;
    }
    .instructions h3 {
      margin: 0 0 10px 0;
      color: #ff6b35;
      font-size: 18px;
    }
    .instructions p {
      margin: 5px 0;
      font-size: 14px;
      color: #776e65;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="heading">2048</div>
    <div class="subtitle">ðŸš‡ Metro de Lima Edition</div>
    
    <div class="instructions">
      <h3>Instrucciones:</h3>
      <p>â€¢ Usa las flechas o desliza para mover las fichas</p>
      <p>â€¢ Combina estaciones iguales para crear nuevas</p>
      <p>â€¢ Â¡Llega a la EstaciÃ³n Central (2048) para ganar!</p>
    </div>

    <div class="score-container">
      <div class="score-box">
        <div>PUNTOS</div>
        <div id="score">0</div>
      </div>
      <div class="score-box">
        <div>MEJOR</div>
        <div id="best">0</div>
      </div>
    </div>

    <div class="game-container">
      <div class="game-message">
        <p></p>
        <div class="lower">
          <a class="restart-button">Intentar de nuevo</a>
        </div>
      </div>

      <div class="grid-container">
        <div class="grid-row">
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
        </div>
        <div class="grid-row">
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
          <div class="grid-cell"></div>
        </div>
      </div>

      <div class="tile-container">
      </div>
    </div>

    <button class="restart-button" onclick="restart()">ðŸ”„ Nuevo Juego</button>
  </div>

  <script>
    // TelemetroAPI Integration
    window.TelemetroAPI = {
      onGameStart: function(gameData) {
        console.log('ðŸŽ® 2048 Metro iniciado:', gameData);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'gameStart',
            game: '2048-metro',
            data: gameData
          }));
        }
      },
      onScoreUpdate: function(score, moves) {
        console.log('ðŸ“Š PuntuaciÃ³n actualizada:', score, 'movimientos:', moves);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'scoreUpdate',
            game: '2048-metro',
            score: score,
            moves: moves,
            points: Math.floor(score / 100) // 1 punto cada 100 puntos de juego
          }));
        }
      },
      onGameOver: function(finalScore, won) {
        console.log('ðŸŽ¯ Juego terminado:', finalScore, won ? 'GANADO' : 'PERDIDO');
        const points = Math.floor(finalScore / 50) + (won ? 50 : 0); // Bonus por ganar
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'gameOver',
            game: '2048-metro',
            finalScore: finalScore,
            won: won,
            points: points
          }));
        }
      },
      onTileReach: function(value) {
        console.log('ðŸ† EstaciÃ³n alcanzada:', value);
        const points = value >= 512 ? 25 : value >= 128 ? 10 : 5;
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'milestone',
            game: '2048-metro',
            milestone: 'tile_' + value,
            points: points
          }));
        }
      }
    };

    // Game Logic
    let board = [];
    let score = 0;
    let hasWon = false;
    let hasLost = false;
    let moves = 0;

    function initGame() {
      board = [
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 0]
      ];
      score = 0;
      moves = 0;
      hasWon = false;
      hasLost = false;
      
      addRandomTile();
      addRandomTile();
      updateDisplay();
      
      // Trigger game start
      window.TelemetroAPI.onGameStart({
        gameId: '2048-metro',
        timestamp: new Date().toISOString()
      });
    }

    function addRandomTile() {
      const emptyCells = [];
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === 0) {
            emptyCells.push({row: i, col: j});
          }
        }
      }
      
      if (emptyCells.length > 0) {
        const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        board[randomCell.row][randomCell.col] = Math.random() < 0.9 ? 2 : 4;
      }
    }

    function updateDisplay() {
      document.getElementById('score').textContent = score;
      
      const tileContainer = document.querySelector('.tile-container');
      tileContainer.innerHTML = '';
      
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] !== 0) {
            const tile = document.createElement('div');
            tile.className = `tile tile-${board[i][j]}`;
            tile.textContent = board[i][j];
            tile.style.left = (j * 121.25 + 15) + 'px';
            tile.style.top = (i * 121.25 + 15) + 'px';
            tileContainer.appendChild(tile);
          }
        }
      }
      
      // Check for win/lose conditions
      if (!hasWon && hasValue(2048)) {
        hasWon = true;
        showGameMessage('Â¡Ganaste!', 'Â¡Llegaste a la EstaciÃ³n Central!');
        window.TelemetroAPI.onGameOver(score, true);
      } else if (!canMove()) {
        hasLost = true;
        showGameMessage('Game Over', 'No hay mÃ¡s movimientos posibles');
        window.TelemetroAPI.onGameOver(score, false);
      }
    }

    function hasValue(value) {
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === value) {
            return true;
          }
        }
      }
      return false;
    }

    function canMove() {
      // Check for empty cells
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (board[i][j] === 0) return true;
        }
      }
      
      // Check for possible merges
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 3; j++) {
          if (board[i][j] === board[i][j + 1] || board[j][i] === board[j + 1][i]) {
            return true;
          }
        }
      }
      
      return false;
    }

    function showGameMessage(title, subtitle) {
      const messageElement = document.querySelector('.game-message');
      messageElement.querySelector('p').innerHTML = title + '<br><span class="lower">' + subtitle + '</span>';
      messageElement.style.display = 'block';
    }

    function move(direction) {
      if (hasWon || hasLost) return;
      
      let moved = false;
      const newBoard = board.map(row => [...row]);
      
      if (direction === 'left') {
        for (let i = 0; i < 4; i++) {
          const row = slideLeft(newBoard[i]);
          if (JSON.stringify(row) !== JSON.stringify(board[i])) moved = true;
          newBoard[i] = row;
        }
      } else if (direction === 'right') {
        for (let i = 0; i < 4; i++) {
          const row = slideRight(newBoard[i]);
          if (JSON.stringify(row) !== JSON.stringify(board[i])) moved = true;
          newBoard[i] = row;
        }
      } else if (direction === 'up') {
        for (let j = 0; j < 4; j++) {
          const column = [newBoard[0][j], newBoard[1][j], newBoard[2][j], newBoard[3][j]];
          const newColumn = slideLeft(column);
          if (JSON.stringify(newColumn) !== JSON.stringify(column)) moved = true;
          for (let i = 0; i < 4; i++) {
            newBoard[i][j] = newColumn[i];
          }
        }
      } else if (direction === 'down') {
        for (let j = 0; j < 4; j++) {
          const column = [newBoard[0][j], newBoard[1][j], newBoard[2][j], newBoard[3][j]];
          const newColumn = slideRight(column);
          if (JSON.stringify(newColumn) !== JSON.stringify(column)) moved = true;
          for (let i = 0; i < 4; i++) {
            newBoard[i][j] = newColumn[i];
          }
        }
      }
      
      if (moved) {
        board = newBoard;
        moves++;
        addRandomTile();
        updateDisplay();
        window.TelemetroAPI.onScoreUpdate(score, moves);
      }
    }

    function slideLeft(row) {
      const filtered = row.filter(val => val !== 0);
      const newRow = [...filtered];
      
      for (let i = 0; i < newRow.length - 1; i++) {
        if (newRow[i] === newRow[i + 1]) {
          newRow[i] *= 2;
          score += newRow[i];
          newRow[i + 1] = 0;
          
          // Trigger milestone event
          if (newRow[i] >= 128) {
            window.TelemetroAPI.onTileReach(newRow[i]);
          }
        }
      }
      
      const finalRow = newRow.filter(val => val !== 0);
      while (finalRow.length < 4) {
        finalRow.push(0);
      }
      
      return finalRow;
    }

    function slideRight(row) {
      return slideLeft(row.slice().reverse()).reverse();
    }

    function restart() {
      document.querySelector('.game-message').style.display = 'none';
      initGame();
    }

    // Event listeners
    document.addEventListener('keydown', function(e) {
      switch(e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          move('left');
          break;
        case 'ArrowRight':
          e.preventDefault();
          move('right');
          break;
        case 'ArrowUp':
          e.preventDefault();
          move('up');
          break;
        case 'ArrowDown':
          e.preventDefault();
          move('down');
          break;
      }
    });

    // Touch support
    let startX = 0;
    let startY = 0;

    document.addEventListener('touchstart', function(e) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', function(e) {
      if (!startX || !startY) return;
      
      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;
      
      const diffX = startX - endX;
      const diffY = startY - endY;
      
      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (diffX > 0) {
          move('left');
        } else {
          move('right');
        }
      } else {
        if (diffY > 0) {
          move('up');
        } else {
          move('down');
        }
      }
      
      startX = 0;
      startY = 0;
    });

    // Initialize game
    initGame();
  </script>
</body>
</html>
